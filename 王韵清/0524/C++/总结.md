# C++11/14 å¯¹æ ‡å‡†åº“çš„æ‰©å……: æ–°å¢å®¹å™¨

## std::array å’Œ std::forward_list

### std::array

çœ‹åˆ°è¿™ä¸ªå®¹å™¨çš„æ—¶å€™è‚¯å®šä¼šå‡ºç°è¿™æ ·çš„é—®é¢˜ï¼š

1. ä¸ºä»€ä¹ˆè¦å¼•å…¥ `std::array` è€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨ `std::vector`ï¼Ÿ

   ç­”ï¼šstd::vecotr` å¤ªå¼ºå¤§äº†ï¼Œä»¥è‡³äºæˆ‘ä»¬æ²¡æœ‰å¿…è¦ä¸ºäº†å»æ•²ç¢ä¸€ä¸ªé¸¡è›‹è€Œç”¨ä¸€ä¸ªé’‰é”¤ã€‚ä½¿ç”¨ `std::array`ä¿å­˜åœ¨æ ˆå†…å­˜ä¸­ï¼Œç›¸æ¯”å †å†…å­˜ä¸­çš„ `std::vector`ï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿçµæ´»çš„è®¿é—®è¿™é‡Œé¢çš„å…ƒç´ ï¼Œä»è€Œè·å¾—æ›´é«˜çš„æ€§èƒ½ï¼›åŒæ—¶æ­£å¼ç”±äºå…¶å †å†…å­˜å­˜å‚¨çš„ç‰¹æ€§ï¼Œæœ‰äº›æ—¶å€™æˆ‘ä»¬è¿˜éœ€è¦è‡ªå·±è´Ÿè´£é‡Šæ”¾è¿™äº›èµ„æºã€‚

2. å·²ç»æœ‰äº†ä¼ ç»Ÿæ•°ç»„ï¼Œä¸ºä»€ä¹ˆè¦ç”¨ `std::array`?

   ç­”ï¼šè€Œç¬¬äºŒä¸ªé—®é¢˜å°±æ›´åŠ ç®€å•ï¼Œä½¿ç”¨`std::array`èƒ½å¤Ÿè®©ä»£ç å˜å¾—æ›´åŠ ç°ä»£ï¼Œä¸”å°è£…äº†ä¸€äº›æ“ä½œå‡½æ•°ï¼ŒåŒæ—¶è¿˜èƒ½å¤Ÿå‹å¥½çš„ä½¿ç”¨æ ‡å‡†åº“ä¸­çš„å®¹å™¨ç®—æ³•ç­‰ç­‰ï¼Œæ¯”å¦‚ `std::sort`ã€‚

`std::array` ä¼šåœ¨ç¼–è¯‘æ—¶åˆ›å»ºä¸€ä¸ªå›ºå®šå¤§å°çš„æ•°ç»„ï¼Œ`std::array` ä¸èƒ½å¤Ÿè¢«éšå¼çš„è½¬æ¢æˆæŒ‡é’ˆï¼Œä½¿ç”¨ `std::array`å¾ˆç®€å•ï¼Œåªéœ€æŒ‡å®šå…¶ç±»å‹å’Œå¤§å°å³å¯ã€‚

```c++
std::array<int, 4> arr= {1,2,3,4};

int len = 4;
std::array<int, len> arr = {1,2,3,4}; // éæ³•, æ•°ç»„å¤§å°å‚æ•°å¿…é¡»æ˜¯å¸¸é‡è¡¨è¾¾å¼
```

å½“æˆ‘ä»¬å¼€å§‹ç”¨ä¸Šäº† `std::array` æ—¶ï¼Œå…¼å®¹ C é£æ ¼çš„æ¥å£çš„åšæ³•ã€‚

   1. å–array[0]åœ°å€
   2. ä½¿ç”¨array.data()

```c++
void foo(int *p, int len) {
return;
}
std::array<int 4> arr = {1,2,3,4};
// C é£æ ¼æ¥å£ä¼ å‚
// foo(arr, arr.size());           // éæ³•, æ— æ³•éšå¼è½¬æ¢
foo(&arr[0], arr.size());
foo(arr.data(), arr.size());
// ä½¿ç”¨ `std::sort`
std::sort(arr.begin(), arr.end());
```

### std::forward_list

`std::forward_list` æ˜¯ä¸€ä¸ªåˆ—è¡¨å®¹å™¨ï¼Œä½¿ç”¨æ–¹æ³•å’Œ `std::list`åŸºæœ¬ç±»ä¼¼

å…¶å’Œ `std::list` çš„åŒå‘é“¾è¡¨çš„å®ç°ä¸åŒï¼Œ`std::forward_list` ä½¿ç”¨å•å‘é“¾è¡¨è¿›è¡Œå®ç°ï¼Œæä¾›äº† `O(1)` å¤æ‚åº¦çš„å…ƒç´ æ’å…¥ï¼Œä¸æ”¯æŒå¿«é€Ÿéšæœºè®¿é—®ï¼ˆè¿™ä¹Ÿæ˜¯é“¾è¡¨çš„ç‰¹ç‚¹ï¼‰ï¼Œä¹Ÿæ˜¯æ ‡å‡†åº“å®¹å™¨ä¸­å”¯ä¸€ä¸€ä¸ªä¸æä¾› `size()` æ–¹æ³•çš„å®¹å™¨ã€‚å½“ä¸éœ€è¦åŒå‘è¿­ä»£æ—¶ï¼Œå…·æœ‰æ¯” `std::list` æ›´é«˜çš„ç©ºé—´åˆ©ç”¨ç‡ã€‚

## æ— åºå®¹å™¨

`std::map`/`std::set`å†…éƒ¨é€šè¿‡çº¢é»‘æ ‘è¿›è¡Œå®ç°ï¼Œæ’å…¥å’Œæœç´¢çš„å¹³å‡å¤æ‚åº¦å‡ä¸º `O(log(size))`ã€‚åœ¨æ’å…¥å…ƒç´ æ—¶å€™ï¼Œä¼šæ ¹æ® `<` æ“ä½œç¬¦æ¯”è¾ƒå…ƒç´ å¤§å°å¹¶åˆ¤æ–­å…ƒç´ æ˜¯å¦ç›¸åŒï¼Œå¹¶é€‰æ‹©åˆé€‚çš„ä½ç½®æ’å…¥åˆ°å®¹å™¨ä¸­ã€‚å½“å¯¹è¿™ä¸ªå®¹å™¨ä¸­çš„å…ƒç´ è¿›è¡Œéå†æ—¶ï¼Œè¾“å‡ºç»“æœä¼šæŒ‰ç…§ `<` æ“ä½œç¬¦çš„é¡ºåºæ¥é€ä¸ªéå†ã€‚

è€Œæ— åºå®¹å™¨ä¸­çš„å…ƒç´ æ˜¯ä¸è¿›è¡Œæ’åºçš„ï¼Œå†…éƒ¨é€šè¿‡ Hash è¡¨å®ç°ï¼Œæ’å…¥å’Œæœç´¢å…ƒç´ çš„å¹³å‡å¤æ‚åº¦ä¸º `O(constant)`ï¼Œåœ¨ä¸å…³å¿ƒå®¹å™¨å†…éƒ¨å…ƒç´ é¡ºåºæ—¶ï¼Œèƒ½å¤Ÿè·å¾—æ˜¾è‘—çš„æ€§èƒ½æå‡ã€‚

C++11 å¼•å…¥äº†ä¸¤ç»„æ— åºå®¹å™¨ï¼š

`std::unordered_map`/`std::unordered_multimap` 

 `std::unordered_set`/`std::unordered_multiset`

ç”¨æ³•å’ŒåŸæœ‰çš„ `std::map`/`std::multimap`/`std::set`/`set::multiset` åŸºæœ¬ç±»ä¼¼

æ¯”è¾ƒ`std::map`å’Œ`std::multimap`ï¼š

```c++
#include <iostream>
#include <string>
#include <unordered_map>
#include <map>

int main() {
    // ä¸¤ç»„ç»“æ„æŒ‰åŒæ ·çš„é¡ºåºåˆå§‹åŒ–
    std::unordered_map<int, std::string> u = {
        {1, "1"},
        {3, "3"},
        {2, "2"}
    };
    std::map<int, std::string> v = {
        {1, "1"},
        {3, "3"},
        {2, "2"}
    };

    // åˆ†åˆ«å¯¹ä¸¤ç§å®¹å™¨è¿›è¡Œéå†
    std::cout << "std::unordered_map" << std::endl;
    for( const auto & n : u) 
        std::cout << "Key:[" << n.first << "] Value:[" << n.second << "]\n";

    std::cout << std::endl;
    std::cout << "std::map" << std::endl;
    for( const auto & n : v) 
        std::cout << "Key:[" << n.first << "] Value:[" << n.second << "]\n";
}
```

æœ€ç»ˆçš„è¾“å‡ºç»“æœä¸ºï¼š

```c++
std::unordered_map
Key:[2] Value:[2]
Key:[3] Value:[3]
Key:[1] Value:[1]

std::map
Key:[1] Value:[1]
Key:[2] Value:[2]
Key:[3] Value:[3]
```

å¯ä»¥çœ‹å‡º`map`å¯¹å…¶è¿›è¡Œäº†æ’åºï¼Œè€Œ`unordered_map`åˆ™ä¸å¯¹å…¶è¿›è¡Œæ’åºã€‚

## å…ƒç»„ std::tuple

### å…ƒç»„åŸºæœ¬æ“ä½œ

å…³äºå…ƒç»„çš„ä½¿ç”¨æœ‰ä¸‰ä¸ªæ ¸å¿ƒçš„å‡½æ•°ï¼š

1. `std::make_tuple`: æ„é€ å…ƒç»„
2. `std::get`: è·å¾—å…ƒç»„æŸä¸ªä½ç½®çš„å€¼
3. `std::tie`: å…ƒç»„æ‹†åŒ…

```c++
#include <tuple>
#include <iostream>

auto get_student(int id)
{
    // è¿”å›ç±»å‹è¢«æ¨æ–­ä¸º std::tuple<double, char, std::string>

    if (id == 0)
        return std::make_tuple(3.8, 'A', "å¼ ä¸‰");
    if (id == 1)
        return std::make_tuple(2.9, 'C', "æå››");
    if (id == 2)
        return std::make_tuple(1.7, 'D', "ç‹äº”");
    return std::make_tuple(0.0, 'D', "null");   
    // å¦‚æœåªå†™ 0 ä¼šå‡ºç°æ¨æ–­é”™è¯¯, ç¼–è¯‘å¤±è´¥
}

int main()
{
    auto student = get_student(0);
    std::cout << "ID: 0, "
    << "GPA: " << std::get<0>(student) << ", "
    << "æˆç»©: " << std::get<1>(student) << ", "
    << "å§“å: " << std::get<2>(student) << '\n';

    double gpa;
    char grade;
    std::string name;

    // å…ƒç»„è¿›è¡Œæ‹†åŒ…
    std::tie(gpa, grade, name) = get_student(1);
    std::cout << "ID: 1, "
    << "GPA: " << gpa << ", "
    << "æˆç»©: " << grade << ", "
    << "å§“å: " << name << '\n';
}
```

`std::get` é™¤äº†ä½¿ç”¨å¸¸é‡è·å–å…ƒç»„å¯¹è±¡å¤–ï¼ŒC++14 å¢åŠ äº†ä½¿ç”¨ç±»å‹æ¥è·å–å…ƒç»„ä¸­çš„å¯¹è±¡ï¼ˆæ„Ÿè§‰ç”¨å¤„ä¸å¤§ï¼Œæ— æ³•è·å–é‡å¤çš„ç±»å‹ï¼‰ï¼š

```c++
std::tuple<std::string, double, double, int> t("123", 4.5, 6.7, 8);
std::cout << std::get<std::string>(t) << std::endl;
std::cout << std::get<double>(t) << std::endl;   // éæ³•, å¼•å‘ç¼–è¯‘æœŸé”™è¯¯
std::cout << std::get<3>(t) << std::endl;
```

### è¿è¡ŒæœŸç´¢å¼•

å¦‚æœä½ ä»”ç»†æ€è€ƒä¸€ä¸‹å¯èƒ½å°±ä¼šå‘ç°ä¸Šé¢ä»£ç çš„é—®é¢˜ï¼Œ`std::get<>` ä¾èµ–ä¸€ä¸ªç¼–è¯‘æœŸçš„å¸¸é‡ï¼Œæ‰€ä»¥ä¸‹é¢çš„æ–¹å¼æ˜¯ä¸åˆæ³•çš„ï¼š

```c++
int index = 1;
std::get<index>(t);
```

é‚£ä¹ˆè¦æ€ä¹ˆå¤„ç†ï¼Ÿç­”æ¡ˆæ˜¯ï¼Œ**æ ‡å‡†åº“åšä¸åˆ°**ã€‚è¿™é‡Œä»‹ç»ä¸€ä¸ªä½¿ç”¨ `boost::variant` é…åˆå˜é•¿æ¨¡æ¿å‚æ•°çš„é»‘é­”æ³•ï¼š

> **æç¤º**ï¼šä½¿ç”¨ `boost` åªæ˜¯æš‚æ—¶æ€§çš„è§£å†³æ–¹æ¡ˆï¼Œ`variant` å·²åœ¨ C++17 ä¸­è¢«çº³å…¥æ ‡å‡†åº“ `std::variant`ï¼Œè§æ‰©å±•ä¸»é¢˜å®ƒçš„è®¨è®ºã€‚<http://en.cppreference.com/w/cpp/utility/variant>

```c++
#include <boost/variant.hpp>
template <size_t n, typename... T>
boost::variant<T...> _tuple_index(size_t i, const std::tuple<T...>& tpl) {
    if (i == n)
        return std::get<n>(tpl);
    else if (n == sizeof...(T) - 1)
        throw std::out_of_range("è¶Šç•Œ.");
    else
        return _tuple_index<(n < sizeof...(T)-1 ? n+1 : 0)>(i, tpl);
}
template <typename... T>
boost::variant<T...> tuple_index(size_t i, const std::tuple<T...>& tpl) {
    return _tuple_index<0>(i, tpl);
}
```

è¿™æ ·æˆ‘ä»¬å°±èƒ½ï¼š

```c++
int i = 1;
std::cout << tuple_index(i, t) << std::endl;
```

### å…ƒç»„åˆå¹¶ä¸éå†

è¿˜æœ‰ä¸€ä¸ªå¸¸è§çš„éœ€æ±‚å°±æ˜¯åˆå¹¶ä¸¤ä¸ªå…ƒç»„ï¼Œè¿™å¯ä»¥é€šè¿‡ `std::tuple_cat` æ¥å®ç°ï¼š

```c++
auto new_tuple = std::tuple_cat(get_student(1), std::move(t));//æ­¤å¤„ä¸ºä½•è¦åŠ moveï¼Ÿ
```

é©¬ä¸Šå°±èƒ½å¤Ÿå‘ç°ï¼Œåº”è¯¥å¦‚ä½•å¿«é€Ÿéå†ä¸€ä¸ªå…ƒç»„ï¼Ÿä½†æ˜¯æˆ‘ä»¬åˆšæ‰ä»‹ç»äº†å¦‚ä½•åœ¨è¿è¡ŒæœŸé€šè¿‡éå¸¸æ•°ç´¢å¼•ä¸€ä¸ª `tuple` é‚£ä¹ˆéå†å°±å˜å¾—ç®€å•äº†ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“ä¸€ä¸ªå…ƒç»„çš„é•¿åº¦ï¼Œå¯ä»¥ï¼š

```c++
template <typename T>
auto tuple_len(T &tpl) {
    return std::tuple_size<T>::value;
}
```

è¿™æ ·å°±èƒ½å¤Ÿå¯¹å…ƒç»„è¿›è¡Œè¿­ä»£äº†ï¼š

```c++
// è¿­ä»£
for(int i = 0; i != tuple_len(new_tuple); ++i)
    // è¿è¡ŒæœŸç´¢å¼•
    std::cout << tuple_index(i, new_tuple) << std::endl;
```

`std::tuple` è™½ç„¶æœ‰æ•ˆï¼Œä½†æ˜¯æ ‡å‡†åº“æä¾›çš„åŠŸèƒ½æœ‰é™ï¼Œæ²¡åŠæ³•æ»¡è¶³è¿è¡ŒæœŸç´¢å¼•å’Œè¿­ä»£çš„éœ€æ±‚ï¼Œå¥½åœ¨æˆ‘ä»¬è¿˜æœ‰å…¶ä»–çš„æ–¹æ³•å¯ä»¥è‡ªè¡Œå®ç°ã€‚

# å¯¹æ ‡å‡†åº“çš„æ‰©å……: æ™ºèƒ½æŒ‡é’ˆå’Œå¼•ç”¨è®¡æ•°

## RAII ä¸å¼•ç”¨è®¡æ•°

å¼•ç”¨è®¡æ•°è¿™ç§è®¡æ•°æ˜¯ä¸ºäº†é˜²æ­¢å†…å­˜æ³„éœ²è€Œäº§ç”Ÿçš„ã€‚åŸºæœ¬æƒ³æ³•æ˜¯å¯¹äºåŠ¨æ€åˆ†é…çš„å¯¹è±¡ï¼Œè¿›è¡Œå¼•ç”¨è®¡æ•°ï¼Œæ¯å½“å¢åŠ ä¸€æ¬¡å¯¹åŒä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨ï¼Œé‚£ä¹ˆå¼•ç”¨å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å°±ä¼šå¢åŠ ä¸€æ¬¡ï¼Œæ¯åˆ é™¤ä¸€æ¬¡å¼•ç”¨ï¼Œå¼•ç”¨è®¡æ•°å°±ä¼šå‡ä¸€ï¼Œå½“ä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨è®¡æ•°å‡ä¸ºé›¶æ—¶ï¼Œå°±è‡ªåŠ¨åˆ é™¤æŒ‡å‘çš„å †å†…å­˜ã€‚

åœ¨ä¼ ç»Ÿ C++ ä¸­ï¼Œã€è®°å¾—ã€æ‰‹åŠ¨é‡Šæ”¾èµ„æºï¼Œæ€»ä¸æ˜¯æœ€ä½³å®è·µã€‚å› ä¸ºæˆ‘ä»¬å¾ˆæœ‰å¯èƒ½å°±å¿˜è®°äº†å»é‡Šæ”¾èµ„æºè€Œå¯¼è‡´æ³„éœ²ã€‚æ‰€ä»¥é€šå¸¸çš„åšæ³•æ˜¯å¯¹äºä¸€ä¸ªå¯¹è±¡è€Œè¨€ï¼Œæˆ‘ä»¬åœ¨æ„é€ å‡½æ•°çš„æ—¶å€™ç”³è¯·ç©ºé—´ï¼Œè€Œåœ¨ææ„å‡½æ•°ï¼ˆåœ¨ç¦»å¼€ä½œç”¨åŸŸæ—¶è°ƒç”¨ï¼‰çš„æ—¶å€™é‡Šæ”¾ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„ RAII èµ„æºè·å–å³åˆå§‹åŒ–æŠ€æœ¯ã€‚

å‡¡äº‹éƒ½æœ‰ä¾‹å¤–ï¼Œæˆ‘ä»¬æ€»ä¼šæœ‰éœ€è¦å°†å¯¹è±¡åœ¨è‡ªç”±å­˜å‚¨ä¸Šåˆ†é…çš„éœ€æ±‚ï¼Œåœ¨ä¼ ç»Ÿ C++ é‡Œæˆ‘ä»¬åªå¥½ä½¿ç”¨ `new` å’Œ `delete` å»ã€è®°å¾—ã€å¯¹èµ„æºè¿›è¡Œé‡Šæ”¾ã€‚è€Œ C++11 å¼•å…¥äº†æ™ºèƒ½æŒ‡é’ˆçš„æ¦‚å¿µï¼Œä½¿ç”¨äº†å¼•ç”¨è®¡æ•°çš„æƒ³æ³•ï¼Œè®©ç¨‹åºå‘˜ä¸å†éœ€è¦å…³å¿ƒæ‰‹åŠ¨é‡Šæ”¾å†…å­˜ã€‚è¿™äº›æ™ºèƒ½æŒ‡é’ˆå°±åŒ…æ‹¬ `std::shared_ptr`/`std::unique_ptr`/`std::weak_ptr`ï¼Œä½¿ç”¨å®ƒä»¬éœ€è¦åŒ…å«å¤´æ–‡ä»¶ `<memory>`ã€‚

> æ³¨æ„ï¼šå¼•ç”¨è®¡æ•°ä¸æ˜¯åƒåœ¾å›æ”¶ï¼Œå¼•ç”¨æŠ€æœ¯èƒ½å¤Ÿå°½å¿«æ”¶å›ä¸å†è¢«ä½¿ç”¨çš„å¯¹è±¡ï¼ŒåŒæ—¶åœ¨å›æ”¶çš„è¿‡ç¨‹ä¸­ä¹Ÿä¸ä¼šé€ æˆé•¿æ—¶é—´çš„ç­‰å¾…ï¼Œæ›´èƒ½å¤Ÿæ¸…æ™°æ˜ç¡®çš„è¡¨æ˜èµ„æºçš„ç”Ÿå‘½å‘¨æœŸã€‚

## std::shared_ptr

`std::shared_ptr` æ˜¯ä¸€ç§æ™ºèƒ½æŒ‡é’ˆï¼Œå®ƒèƒ½å¤Ÿè®°å½•å¤šå°‘ä¸ª `shared_ptr` å…±åŒæŒ‡å‘ä¸€ä¸ªå¯¹è±¡ï¼Œä»è€Œæ¶ˆé™¤æ˜¾ç¤ºçš„è°ƒç”¨ `delete`ï¼Œå½“å¼•ç”¨è®¡æ•°å˜ä¸ºé›¶çš„æ—¶å€™å°±ä¼šå°†å¯¹è±¡è‡ªåŠ¨åˆ é™¤ã€‚

ä½†è¿˜ä¸å¤Ÿï¼Œå› ä¸ºä½¿ç”¨ `std::shared_ptr` ä»ç„¶éœ€è¦ä½¿ç”¨ `new` æ¥è°ƒç”¨ï¼Œè¿™ä½¿å¾—ä»£ç å‡ºç°äº†æŸç§ç¨‹åº¦ä¸Šçš„ä¸å¯¹ç§°ã€‚

`std::make_shared` å°±èƒ½å¤Ÿç”¨æ¥æ¶ˆé™¤æ˜¾ç¤ºçš„ä½¿ç”¨ `new`ï¼Œæ‰€ä»¥`std::make_shared` ä¼šåˆ†é…åˆ›å»ºä¼ å…¥å‚æ•°ä¸­çš„å¯¹è±¡ï¼Œå¹¶è¿”å›è¿™ä¸ªå¯¹è±¡ç±»å‹çš„`std::shared_ptr`æŒ‡é’ˆã€‚ä¾‹å¦‚ï¼š

```c++
#include <iostream>
#include <memory>

void foo(std::shared_ptr<int> i)
{
    (*i)++;
}
int main()
{
    // auto pointer = new int(10); // éæ³•, ä¸å…è®¸ç›´æ¥èµ‹å€¼
    // æ„é€ äº†ä¸€ä¸ª std::shared_ptr
    auto pointer = std::make_shared<int>(10);
    foo(pointer);
    std::cout << *pointer << std::endl; // 11

    // ç¦»å¼€ä½œç”¨åŸŸå‰ï¼Œshared_ptr ä¼šè¢«ææ„ï¼Œä»è€Œé‡Šæ”¾å†…å­˜
    return 0;
}
```

`std::shared_ptr` å¯ä»¥é€šè¿‡ `get()` æ–¹æ³•æ¥è·å–åŸå§‹æŒ‡é’ˆï¼Œé€šè¿‡ `reset()` æ¥å‡å°‘ä¸€ä¸ªå¼•ç”¨è®¡æ•°ï¼Œå¹¶é€šè¿‡`get_count()`æ¥æŸ¥çœ‹ä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨è®¡æ•°ã€‚ä¾‹å¦‚ï¼š

```c++
auto pointer = std::make_shared<int>(10);
auto pointer2 = pointer;    // å¼•ç”¨è®¡æ•°+1
auto pointer3 = pointer;    // å¼•ç”¨è®¡æ•°+1
int *p = pointer.get();     // è¿™æ ·ä¸ä¼šå¢åŠ å¼•ç”¨è®¡æ•°

std::cout << "pointer.use_count() = " << pointer.use_count() << std::endl;      // 3
std::cout << "pointer2.use_count() = " << pointer2.use_count() << std::endl;    // 3
std::cout << "pointer3.use_count() = " << pointer3.use_count() << std::endl;    // 3

pointer2.reset();
std::cout << "reset pointer2:" << std::endl;
std::cout << "pointer.use_count() = " << pointer.use_count() << std::endl;      // 2
std::cout << "pointer2.use_count() = " << pointer2.use_count() << std::endl;    // 0, pointer2 å·² reset
std::cout << "pointer3.use_count() = " << pointer3.use_count() << std::endl;    // 2

pointer3.reset();
std::cout << "reset pointer3:" << std::endl;
std::cout << "pointer.use_count() = " << pointer.use_count() << std::endl;      // 1
std::cout << "pointer2.use_count() = " << pointer2.use_count() << std::endl;    // 0
std::cout << "pointer3.use_count() = " << pointer3.use_count() << std::endl;    // 0, pointer3 å·² reset
```

## std::unique_ptr

`std::unique_ptr` æ˜¯ä¸€ç§ç‹¬å çš„æ™ºèƒ½æŒ‡é’ˆï¼Œå®ƒç¦æ­¢å…¶ä»–æ™ºèƒ½æŒ‡é’ˆä¸å…¶å…±äº«åŒä¸€ä¸ªå¯¹è±¡ï¼Œä»è€Œä¿è¯äº†ä»£ç çš„å®‰å…¨ï¼š

```c++
std::unique_ptr<int> pointer = std::make_unique<int>(10);   // make_unique ä» C++14 å¼•å…¥
std::unique_ptr<int> pointer2 = pointer;    // éæ³•
```

> make_unique å¹¶ä¸å¤æ‚ï¼ŒC++11 æ²¡æœ‰æä¾› std::make_uniqueï¼Œå¯ä»¥è‡ªè¡Œå®ç°ï¼š
>
> ```c++
> template<typename T, typename ...Args>
> std::unique_ptr<T> make_unique( Args&& ...args ) {
>     return std::unique_ptr<T>( new T( std::forward<Args>(args)... ) );
> }
> ```
>
> è‡³äºä¸ºä»€ä¹ˆæ²¡æœ‰æä¾›ï¼ŒC++ æ ‡å‡†å§”å‘˜ä¼šä¸»å¸­ Herb Sutter åœ¨ä»–çš„[åšå®¢](https://herbsutter.com/gotw/_102/)ä¸­æåˆ°åŸå› æ˜¯å› ä¸ºã€è¢«ä»–ä»¬å¿˜è®°äº†ã€ã€‚

æ—¢ç„¶æ˜¯ç‹¬å ï¼Œæ¢å¥è¯è¯´å°±æ˜¯ä¸å¯å¤åˆ¶ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ `std::move` å°†å…¶è½¬ç§»ç»™å…¶ä»–çš„ `unique_ptr`ï¼Œä¾‹å¦‚ï¼š

```c++
#include <iostream>
#include <memory>

struct Foo {
    Foo()      { std::cout << "Foo::Foo" << std::endl;  }
    ~Foo()     { std::cout << "Foo::~Foo" << std::endl; }
    void foo() { std::cout << "Foo::foo" << std::endl;  }
};

void f(const Foo &) {
    std::cout << "f(const Foo&)" << std::endl;
}

int main() {
    std::unique_ptr<Foo> p1(std::make_unique<Foo>());

    // p1 ä¸ç©º, è¾“å‡º
    if (p1) p1->foo();
    {
        std::unique_ptr<Foo> p2(std::move(p1));

        // p2 ä¸ç©º, è¾“å‡º
        f(*p2);

        // p2 ä¸ç©º, è¾“å‡º
        if(p2) p2->foo();

        // p1 ä¸ºç©º, æ— è¾“å‡º
        if(p1) p1->foo();

        p1 = std::move(p2);

        // p2 ä¸ºç©º, æ— è¾“å‡º
        if(p2) p2->foo();
        std::cout << "p2 è¢«é”€æ¯" << std::endl;
    }
    // p1 ä¸ç©º, è¾“å‡º
    if (p1) p1->foo();

    // Foo çš„å®ä¾‹ä¼šåœ¨ç¦»å¼€ä½œç”¨åŸŸæ—¶è¢«é”€æ¯
}
```

## std::weak_ptr

å¦‚æœä½ ä»”ç»†æ€è€ƒ `std::shared_ptr` å°±ä¼šå‘ç°ä¾ç„¶å­˜åœ¨ç€èµ„æºæ— æ³•é‡Šæ”¾çš„é—®é¢˜ã€‚çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š

```c++
#include <iostream>
#include <memory>

class A;
class B;

class A {
public:
    std::shared_ptr<B> pointer;
    ~A() {
        std::cout << "A è¢«é”€æ¯" << std::endl;
    }
};
class B {
public:
    std::shared_ptr<A> pointer;
    ~B() {
        std::cout << "B è¢«é”€æ¯" << std::endl;
    }
};
int main() {
    std::shared_ptr<A> a = std::make_shared<A>();
    std::shared_ptr<B> b = std::make_shared<B>();
    a->pointer = b;
    b->pointer = a;

    return 0;
}
```

è¿è¡Œç»“æœæ˜¯ A, B éƒ½ä¸ä¼šè¢«é”€æ¯ï¼Œè¿™æ˜¯å› ä¸º a,b å†…éƒ¨çš„ pointer åŒæ—¶åˆå¼•ç”¨äº† `a,b`ï¼Œè¿™ä½¿å¾— `a,b` çš„å¼•ç”¨è®¡æ•°å‡å˜ä¸ºäº† 2ï¼Œè€Œç¦»å¼€ä½œç”¨åŸŸæ—¶ï¼Œ`a,b` æ™ºèƒ½æŒ‡é’ˆè¢«ææ„ï¼Œå´æ™ºèƒ½é€ æˆè¿™å—åŒºåŸŸçš„å¼•ç”¨è®¡æ•°å‡ä¸€ï¼Œè¿™æ ·å°±å¯¼è‡´äº† `a,b` å¯¹è±¡æŒ‡å‘çš„å†…å­˜åŒºåŸŸå¼•ç”¨è®¡æ•°ä¸ä¸ºé›¶ï¼Œè€Œå¤–éƒ¨å·²ç»æ²¡æœ‰åŠæ³•æ‰¾åˆ°è¿™å—åŒºåŸŸäº†ï¼Œä¹Ÿå°±é€ æˆäº†å†…å­˜æ³„éœ²ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š

![sp](assets/wm-1558679391071.png)

è§£å†³è¿™ä¸ªé—®é¢˜çš„åŠæ³•å°±æ˜¯ä½¿ç”¨å¼±å¼•ç”¨æŒ‡é’ˆ `std::weak_ptr`ï¼Œ`std::weak_ptr`æ˜¯ä¸€ç§å¼±å¼•ç”¨ï¼ˆç›¸æ¯”è¾ƒè€Œè¨€ `std::shared_ptr`å°±æ˜¯ä¸€ç§å¼ºå¼•ç”¨ï¼‰ã€‚å¼±å¼•ç”¨ä¸ä¼šå¼•èµ·å¼•ç”¨è®¡æ•°å¢åŠ ï¼Œå½“æ¢ç”¨å¼±å¼•ç”¨æ—¶å€™ï¼Œæœ€ç»ˆçš„é‡Šæ”¾æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![æ­¤å¤„è¾“å…¥å›¾ç‰‡çš„æè¿°](assets/wm.png)

åœ¨ä¸Šå›¾ä¸­ï¼Œæœ€åä¸€æ­¥åªå‰©ä¸‹ Bï¼Œè€Œ B å¹¶æ²¡æœ‰ä»»ä½•æ™ºèƒ½æŒ‡é’ˆå¼•ç”¨å®ƒï¼Œå› æ­¤è¿™å—å†…å­˜èµ„æºä¹Ÿä¼šè¢«é‡Šæ”¾ã€‚

`std::weak_ptr` æ²¡æœ‰ `*` è¿ç®—ç¬¦å’Œ `->` è¿ç®—ç¬¦ï¼Œæ‰€ä»¥ä¸èƒ½å¤Ÿå¯¹èµ„æºè¿›è¡Œæ“ä½œï¼Œå®ƒçš„å”¯ä¸€ä½œç”¨å°±æ˜¯ç”¨äºæ£€æŸ¥ `std::shared_ptr`æ˜¯å¦å­˜åœ¨ï¼Œ`expired()` æ–¹æ³•åœ¨èµ„æºæœªè¢«é‡Šæ”¾æ—¶ï¼Œä¼šè¿”å› `true`ï¼Œå¦åˆ™è¿”å› `false`ã€‚

æ­£ç¡®çš„ä»£ç å¦‚ä¸‹ï¼š

```c++
#include <iostream>
#include <memory>

class A;
class B;

class A {
public:
    // A æˆ– B ä¸­è‡³å°‘æœ‰ä¸€ä¸ªä½¿ç”¨ weak_ptr
    std::weak_ptr<B> pointer;
    ~A() {
        std::cout << "A è¢«é”€æ¯" << std::endl;
    }
};
class B {
public:
    std::shared_ptr<A> pointer;
    ~B() {
        std::cout << "B è¢«é”€æ¯" << std::endl;
    }
};
int main() {
    std::shared_ptr<A> a = std::make_shared<A>();
    std::shared_ptr<B> b = std::make_shared<B>();
    a->pointer = b;
    b->pointer = a;

    return 0;
}
```

## std::regex åŠå…¶ç›¸å…³

å¯¹å­—ç¬¦ä¸²å†…å®¹è¿›è¡ŒåŒ¹é…çš„æœ€å¸¸è§æ‰‹æ®µå°±æ˜¯ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ã€‚å¯æƒœåœ¨ä¼ ç»Ÿ C++ ä¸­æ­£åˆ™è¡¨è¾¾å¼ä¸€ç›´æ²¡æœ‰å¾—åˆ°è¯­è¨€å±‚é¢çš„æ”¯æŒï¼Œæ²¡æœ‰çº³å…¥æ ‡å‡†åº“ï¼Œè€Œ C++ ä½œä¸ºä¸€é—¨é«˜æ€§èƒ½è¯­è¨€ï¼Œåœ¨åå°æœåŠ¡çš„å¼€å‘ä¸­ï¼Œå¯¹ URL èµ„æºé“¾æ¥è¿›è¡Œåˆ¤æ–­æ—¶ï¼Œä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ä¹Ÿæ˜¯å·¥ä¸šç•Œæœ€ä¸ºæˆç†Ÿçš„æ™®éåšæ³•ã€‚

ä¸€èˆ¬çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯ä½¿ç”¨ `boost` çš„æ­£åˆ™è¡¨è¾¾å¼åº“ã€‚è€Œ C++11 æ­£å¼å°†æ­£åˆ™è¡¨è¾¾å¼çš„çš„å¤„ç†æ–¹æ³•çº³å…¥æ ‡å‡†åº“çš„è¡Œåˆ—ï¼Œä»è¯­è¨€çº§ä¸Šæä¾›äº†æ ‡å‡†çš„æ”¯æŒï¼Œä¸å†ä¾èµ–ç¬¬ä¸‰æ–¹ã€‚

C++11 æä¾›çš„æ­£åˆ™è¡¨è¾¾å¼åº“æ“ä½œ `std::string` å¯¹è±¡ï¼Œæ¨¡å¼ `std::regex` (æœ¬è´¨æ˜¯ `std::basic_regex`)è¿›è¡Œåˆå§‹åŒ–ï¼Œé€šè¿‡ `std::regex_match` è¿›è¡ŒåŒ¹é…ï¼Œä»è€Œäº§ç”Ÿ `std::smatch` ï¼ˆæœ¬è´¨æ˜¯ `std::match_results` å¯¹è±¡ï¼‰ã€‚

æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥ç®€å•ä»‹ç»è¿™ä¸ªåº“çš„ä½¿ç”¨ã€‚è€ƒè™‘ä¸‹é¢çš„æ­£åˆ™è¡¨è¾¾å¼

- `[a-z]+\.txt`: åœ¨è¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼ä¸­, `[a-z]` è¡¨ç¤ºåŒ¹é…ä¸€ä¸ªå°å†™å­—æ¯, `+` å¯ä»¥ä½¿å‰é¢çš„è¡¨è¾¾å¼åŒ¹é…å¤šæ¬¡ï¼Œå› æ­¤ `[a-z]+` èƒ½å¤ŸåŒ¹é…ä¸€ä¸ªå°å†™å­—æ¯ç»„æˆçš„å­—ç¬¦ä¸²ã€‚åœ¨æ­£åˆ™è¡¨è¾¾å¼ä¸­ä¸€ä¸ª `.` è¡¨ç¤ºåŒ¹é…ä»»æ„å­—ç¬¦ï¼Œè€Œ `\.` åˆ™è¡¨ç¤ºåŒ¹é…å­—ç¬¦ `.`ï¼Œæœ€åçš„ `txt` è¡¨ç¤ºä¸¥æ ¼åŒ¹é… `txt` åˆ™ä¸‰ä¸ªå­—æ¯ã€‚å› æ­¤è¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼çš„æ‰€è¦åŒ¹é…çš„å†…å®¹å°±æ˜¯ç”±çº¯å°å†™å­—æ¯ç»„æˆçš„æ–‡æœ¬æ–‡ä»¶ã€‚

`std::regex_match` ç”¨äºåŒ¹é…å­—ç¬¦ä¸²å’Œæ­£åˆ™è¡¨è¾¾å¼ï¼Œæœ‰å¾ˆå¤šä¸åŒçš„é‡è½½å½¢å¼ã€‚æœ€ç®€å•çš„ä¸€ä¸ªå½¢å¼å°±æ˜¯ä¼ å…¥`std::string` ä»¥åŠä¸€ä¸ª `std::regex` è¿›è¡ŒåŒ¹é…ï¼Œå½“åŒ¹é…æˆåŠŸæ—¶ï¼Œä¼šè¿”å› `true`ï¼Œå¦åˆ™è¿”å› `false`ã€‚ä¾‹å¦‚ï¼š

```c++
#include <iostream>
#include <string>
#include <regex>

int main() {
    std::string fnames[] = {"foo.txt", "bar.txt", "test", "a0.txt", "AAA.txt"};
    // åœ¨ C++ ä¸­ `\` ä¼šè¢«ä½œä¸ºå­—ç¬¦ä¸²å†…çš„è½¬ä¹‰ç¬¦ï¼Œä¸ºä½¿ `\.` ä½œä¸ºæ­£åˆ™è¡¨è¾¾å¼ä¼ é€’è¿›å»ç”Ÿæ•ˆï¼Œéœ€è¦å¯¹ `\` è¿›è¡ŒäºŒæ¬¡è½¬ä¹‰ï¼Œä»è€Œæœ‰ `\\.`
    std::regex txt_regex("[a-z]+\\.txt");
    for (const auto &fname: fnames)
        std::cout << fname << ": " << std::regex_match(fname, txt_regex) << std::endl;
}
```

å¦ä¸€ç§å¸¸ç”¨çš„å½¢å¼å°±æ˜¯ä¾æ¬¡ä¼ å…¥ `std::string`/`std::smatch`/`std::regex` ä¸‰ä¸ªå‚æ•°ï¼Œå…¶ä¸­ `std::smatch` çš„æœ¬è´¨å…¶å®æ˜¯ `std::match_results`ï¼Œåœ¨æ ‡å‡†åº“ä¸­ï¼Œ `std::smatch` è¢«å®šä¹‰ä¸ºäº† `std::match_results<std::string::const_iterator>`ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªå­ä¸²è¿­ä»£å™¨ç±»å‹çš„ `match_results`ã€‚ä½¿ç”¨ `std::smatch`å¯ä»¥æ–¹ä¾¿çš„å¯¹åŒ¹é…çš„ç»“æœè¿›è¡Œè·å–ï¼Œä¾‹å¦‚ï¼š

```c++
std::regex base_regex("([a-z]+)\\.txt");
std::smatch base_match;
for(const auto &fname: fnames) {
    if (std::regex_match(fname, base_match, base_regex)) {
        // sub_match çš„ç¬¬ä¸€ä¸ªå…ƒç´ åŒ¹é…æ•´ä¸ªå­—ç¬¦ä¸²
        // sub_match çš„ç¬¬äºŒä¸ªå…ƒç´ åŒ¹é…äº†ç¬¬ä¸€ä¸ªæ‹¬å·è¡¨è¾¾å¼
        if (base_match.size() == 2) {
            std::string base = base_match[1].str();
            std::cout << "sub-match[0]: " << base_match[0].str() << std::endl;
            std::cout << fname << " sub-match[1]: " << base << std::endl;
        }
    }
}
```

ä»¥ä¸Šä¸¤ä¸ªä»£ç æ®µçš„è¾“å‡ºç»“æœä¸ºï¼š

```
foo.txt: 1
bar.txt: 1
test: 0
a0.txt: 0
AAA.txt: 0
sub-match[0]: foo.txt
foo.txt sub-match[1]: foo
sub-match[0]: bar.txt
bar.txt sub-match[1]: bar
```

# å¯¹æ ‡å‡†åº“çš„æ‰©å……: è¯­è¨€çº§çº¿ç¨‹æ”¯æŒ

æç¤ºï¼šæœ‰å…³å¤šçº¿ç¨‹çš„ä»£ç ç¼–è¯‘éœ€è¦ä½¿ç”¨ `-pthread` é€‰é¡¹ï¼Œä¾‹å¦‚ï¼š

```shell
g++ main.cpp -std=c++14 -pthread
```

## std::thread

`std::thread` ç”¨äºåˆ›å»ºä¸€ä¸ªæ‰§è¡Œçš„çº¿ç¨‹å®ä¾‹ï¼Œæ‰€ä»¥å®ƒæ˜¯ä¸€åˆ‡å¹¶å‘ç¼–ç¨‹çš„åŸºç¡€ï¼Œä½¿ç”¨æ—¶éœ€è¦åŒ…å«<thread>å¤´æ–‡ä»¶ï¼Œå®ƒæä¾›äº†å¾ˆå¤šåŸºæœ¬çš„çº¿ç¨‹æ“ä½œï¼Œä¾‹å¦‚`get_id()`æ¥è·å–æ‰€åˆ›å»ºçº¿ç¨‹çš„çº¿ç¨‹ IDï¼Œä¾‹å¦‚ä½¿ç”¨ `join()` æ¥åŠ å…¥ä¸€ä¸ªçº¿ç¨‹ç­‰ç­‰ï¼Œä¾‹å¦‚ï¼š

```c++
#include <iostream>
#include <thread>
void foo() {
    std::cout << "hello world" << std::endl;
}
int main() {
    std::thread t(foo);
    t.join();//å¼€å§‹è¿è¡Œ
    return 0;
}
```

## std::mutex, std::unique_lock

C++11å¼•å…¥äº† mutex ç›¸å…³çš„ç±»ï¼Œå…¶æ‰€æœ‰ç›¸å…³çš„å‡½æ•°éƒ½æ”¾åœ¨ `<mutex>` å¤´æ–‡ä»¶ä¸­ã€‚

`std::mutex` æ˜¯ C++11 ä¸­æœ€åŸºæœ¬çš„ `mutex` ç±»ï¼Œé€šè¿‡å®ä¾‹åŒ– `std::mutex` å¯ä»¥åˆ›å»ºäº’æ–¥é‡ï¼Œè€Œé€šè¿‡å…¶æˆå‘˜å‡½æ•° `lock()` å¯ä»¥ä»…æ­¤èƒ½ä¸Šé”ï¼Œ`unlock()` å¯ä»¥è¿›è¡Œè§£é”ã€‚ä½†æ˜¯åœ¨åœ¨å®é™…ç¼–å†™ä»£ç çš„è¿‡ç¨‹ä¸­ï¼Œæœ€å¥½ä¸å»ç›´æ¥è°ƒç”¨æˆå‘˜å‡½æ•°ï¼Œå› ä¸ºè°ƒç”¨æˆå‘˜å‡½æ•°å°±éœ€è¦åœ¨æ¯ä¸ªä¸´ç•ŒåŒºçš„å‡ºå£å¤„è°ƒç”¨ `unlock()`ï¼Œå½“ç„¶ï¼Œè¿˜åŒ…æ‹¬å¼‚å¸¸ã€‚è¿™æ—¶å€™ C++11 è¿˜ä¸ºäº’æ–¥é‡æä¾›äº†ä¸€ä¸ª RAII è¯­æ³•çš„æ¨¡æ¿ç±»`std::lock_gurad`ã€‚RAII åœ¨ä¸å¤±ä»£ç ç®€æ´æ€§çš„åŒæ—¶ï¼Œå¾ˆå¥½çš„ä¿è¯äº†ä»£ç çš„å¼‚å¸¸å®‰å…¨æ€§ã€‚

åœ¨ RAII ç”¨æ³•ä¸‹ï¼Œå¯¹äºä¸´ç•ŒåŒºçš„äº’æ–¥é‡çš„åˆ›å»ºåªéœ€è¦åœ¨ä½œç”¨åŸŸçš„å¼€å§‹éƒ¨åˆ†ï¼Œä¾‹å¦‚ï¼š

```c++
void some_operation(const std::string &message) {
    static std::mutex mutex;
    std::lock_guard<std::mutex> lock(mutex);

    // ...æ“ä½œ

    // å½“ç¦»å¼€è¿™ä¸ªä½œç”¨åŸŸçš„æ—¶å€™ï¼Œäº’æ–¥é”ä¼šè¢«ææ„ï¼ŒåŒæ—¶unlockäº’æ–¥é”
    // å› æ­¤è¿™ä¸ªå‡½æ•°å†…éƒ¨çš„å¯ä»¥è®¤ä¸ºæ˜¯ä¸´ç•ŒåŒº
}
```

ç”±äº C++ä¿è¯äº†æ‰€æœ‰æ ˆå¯¹è±¡åœ¨å£°æ˜å‘¨æœŸç»“æŸæ—¶ä¼šè¢«é”€æ¯ï¼Œæ‰€ä»¥è¿™æ ·çš„ä»£ç ä¹Ÿæ˜¯å¼‚å¸¸å®‰å…¨çš„ã€‚æ— è®º `some_operation()` æ­£å¸¸è¿”å›ã€è¿˜æ˜¯åœ¨ä¸­é€”æŠ›å‡ºå¼‚å¸¸ï¼Œéƒ½ä¼šå¼•å‘å †æ ˆå›é€€ï¼Œä¹Ÿå°±è‡ªåŠ¨è°ƒç”¨äº† `unlock()`ã€‚

è€Œ `std::unique_lock` åˆ™ç›¸å¯¹äº `std::lock_guard` å‡ºç°çš„ï¼Œ`std::unique_lock` æ›´åŠ çµæ´»ï¼Œ`std::unique_lock` çš„å¯¹è±¡ä¼šä»¥ç‹¬å æ‰€æœ‰æƒï¼ˆæ²¡æœ‰å…¶ä»–çš„ `unique_lock` å¯¹è±¡åŒæ—¶æ‹¥æœ‰æŸä¸ª `mutex` å¯¹è±¡çš„æ‰€æœ‰æƒï¼‰çš„æ–¹å¼ç®¡ç† `mutex` å¯¹è±¡ä¸Šçš„ä¸Šé”å’Œè§£é”çš„æ“ä½œã€‚æ‰€ä»¥åœ¨å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œæ¨èä½¿ç”¨ `std::unique_lock`ã€‚ä¾‹å¦‚ï¼š

```c++
#include <iostream>
#include <thread>
#include <mutex>

std::mutex mtx;

void block_area() {
    std::unique_lock<std::mutex> lock(mtx);
    //...ä¸´ç•ŒåŒº
}
int main() {
    std::thread thd1(block_area);

    thd1.join();

    return 0;
}
```

## std::future, std::packaged_task

`std::future` åˆ™æ˜¯æä¾›äº†ä¸€ä¸ªè®¿é—®å¼‚æ­¥æ“ä½œç»“æœçš„é€”å¾„ï¼Œè¿™å¥è¯å¾ˆä¸å¥½ç†è§£ã€‚ä¸ºäº†ç†è§£è¿™ä¸ªç‰¹æ€§ï¼Œæˆ‘ä»¬éœ€è¦å…ˆç†è§£ä¸€ä¸‹åœ¨ C++11ä¹‹å‰çš„å¤šçº¿ç¨‹è¡Œä¸ºã€‚

è¯•æƒ³ï¼Œå¦‚æœæˆ‘ä»¬çš„ä¸»çº¿ç¨‹ A å¸Œæœ›æ–°å¼€è¾Ÿä¸€ä¸ªçº¿ç¨‹ B å»æ‰§è¡ŒæŸä¸ªæˆ‘ä»¬é¢„æœŸçš„ä»»åŠ¡ï¼Œå¹¶è¿”å›æˆ‘ä¸€ä¸ªç»“æœã€‚è€Œè¿™æ—¶å€™ï¼Œçº¿ç¨‹ A å¯èƒ½æ­£åœ¨å¿™å…¶ä»–çš„äº‹æƒ…ï¼Œæ— æš‡é¡¾åŠ B çš„ç»“æœï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šå¾ˆè‡ªç„¶çš„å¸Œæœ›èƒ½å¤Ÿåœ¨æŸä¸ªç‰¹å®šçš„æ—¶é—´è·å¾—çº¿ç¨‹ B çš„ç»“æœã€‚

åœ¨ C++11 çš„ `std::future` è¢«å¼•å…¥ä¹‹å‰ï¼Œé€šå¸¸çš„åšæ³•æ˜¯ï¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹Aï¼Œåœ¨çº¿ç¨‹Aé‡Œå¯åŠ¨ä»»åŠ¡ Bï¼Œå½“å‡†å¤‡å®Œæ¯•åå‘é€ä¸€ä¸ªäº‹ä»¶ï¼Œå¹¶å°†ç»“æœä¿å­˜åœ¨å…¨å±€å˜é‡ä¸­ã€‚è€Œä¸»å‡½æ•°çº¿ç¨‹ A é‡Œæ­£åœ¨åšå…¶ä»–çš„äº‹æƒ…ï¼Œå½“éœ€è¦ç»“æœçš„æ—¶å€™ï¼Œè°ƒç”¨ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å‡½æ•°æ¥è·å¾—æ‰§è¡Œçš„ç»“æœã€‚

è€Œ C++11 æä¾›çš„ `std::future` ç®€åŒ–äº†è¿™ä¸ªæµç¨‹ï¼Œå¯ä»¥ç”¨æ¥è·å–å¼‚æ­¥ä»»åŠ¡çš„ç»“æœã€‚è‡ªç„¶åœ°ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“èƒ½å¤Ÿæƒ³è±¡åˆ°æŠŠå®ƒä½œä¸ºä¸€ç§ç®€å•çš„çº¿ç¨‹åŒæ­¥æ‰‹æ®µã€‚

æ­¤å¤–ï¼Œ`std::packaged_task` å¯ä»¥ç”¨æ¥å°è£…ä»»ä½•å¯ä»¥è°ƒç”¨çš„ç›®æ ‡ï¼Œä»è€Œç”¨äºå®ç°å¼‚æ­¥çš„è°ƒç”¨ã€‚ä¾‹å¦‚ï¼š

```c++
#include <iostream>
#include <future>
#include <thread>

int main() {
    // å°†ä¸€ä¸ªè¿”å›å€¼ä¸º7çš„ lambda è¡¨è¾¾å¼å°è£…åˆ° task ä¸­
    // std::packaged_task çš„æ¨¡æ¿å‚æ•°ä¸ºè¦å°è£…å‡½æ•°çš„ç±»å‹
    std::packaged_task<int()> task([](){return 7;});
    // è·å¾— task çš„ future
    std::future<int> result = task.get_future();    // åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œ task
    std::thread(std::move(task)).detach();
    std::cout << "Waiting...";
    result.wait();
    // è¾“å‡ºæ‰§è¡Œç»“æœ
    std::cout << "Done!" << std:: endl << "Result is " << result.get() << '\n';
}
```

![1558682074912](assets/1558682074912.png)

åœ¨å°è£…å¥½è¦è°ƒç”¨çš„ç›®æ ‡åï¼Œå¯ä»¥ä½¿ç”¨ `get_future()` æ¥è·å¾—ä¸€ä¸ª `std::future` å¯¹è±¡ï¼Œä»¥ä¾¿ä¹‹åäº‹å®çº¿ç¨‹åŒæ­¥ã€‚

## std::condition_variable

`std::condition_variable` æ˜¯ä¸ºäº†è§£å†³æ­»é”è€Œç”Ÿçš„ã€‚å½“äº’æ–¥æ“ä½œä¸å¤Ÿç”¨è€Œå¼•å…¥çš„ã€‚æ¯”å¦‚ï¼Œçº¿ç¨‹å¯èƒ½éœ€è¦ç­‰å¾…æŸä¸ªæ¡ä»¶ä¸ºçœŸæ‰èƒ½ç»§ç»­æ‰§è¡Œï¼Œè€Œä¸€ä¸ªå¿™ç­‰å¾…å¾ªç¯ä¸­å¯èƒ½ä¼šå¯¼è‡´æ‰€æœ‰å…¶ä»–çº¿ç¨‹éƒ½æ— æ³•è¿›å…¥ä¸´ç•ŒåŒºä½¿å¾—æ¡ä»¶ä¸ºçœŸæ—¶ï¼Œå°±ä¼šå‘ç”Ÿæ­»é”ã€‚æ‰€ä»¥ï¼Œ`condition_variable` å®ä¾‹è¢«åˆ›å»ºå‡ºç°ä¸»è¦å°±æ˜¯ç”¨äºå”¤é†’ç­‰å¾…çº¿ç¨‹ä»è€Œé¿å…æ­»é”ã€‚`std::condition_variable`çš„ `notify_one()` ç”¨äºå”¤é†’ä¸€ä¸ªçº¿ç¨‹ï¼›`notify_all()` åˆ™æ˜¯é€šçŸ¥æ‰€æœ‰çº¿ç¨‹ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ¨¡å‹çš„ä¾‹å­ï¼š

```c++
#include <condition_variable>
#include <mutex>
#include <thread>
#include <iostream>
#include <queue>
#include <chrono>

int main()
{
    // ç”Ÿäº§è€…æ•°é‡
    std::queue<int> produced_nums;
    // äº’æ–¥é”
    std::mutex m;
    // æ¡ä»¶å˜é‡
    std::condition_variable cond_var;
    // ç»“æŸæ ‡å¿—
    bool done = false;
    // é€šçŸ¥æ ‡å¿—
    bool notified = false;

    // ç”Ÿäº§è€…çº¿ç¨‹
    std::thread producer([&]() {
        for (int i = 0; i < 5; ++i) {
            std::this_thread::sleep_for(std::chrono::seconds(1));
            // åˆ›å»ºäº’æ–¥é”
            std::unique_lock<std::mutex> lock(m);
            std::cout << "producing " << i << '\n';
            produced_nums.push(i);
            notified = true;
            // é€šçŸ¥ä¸€ä¸ªçº¿ç¨‹
            cond_var.notify_one();
        }   
        done = true;
        cond_var.notify_one();
    }); 

    // æ¶ˆè´¹è€…çº¿ç¨‹
    std::thread consumer([&]() {
        std::unique_lock<std::mutex> lock(m);
        while (!done) {
            while (!notified) {  // å¾ªç¯é¿å…è™šå‡å”¤é†’
                cond_var.wait(lock);
            }   
            while (!produced_nums.empty()) {
                std::cout << "consuming " << produced_nums.front() << '\n';
                produced_nums.pop();
            }   
            notified = false;
        }   
    }); 

    producer.join();
    consumer.join();
}
```

![1558681961485](assets/1558681961485.png)

# noexcept çš„ä¿®é¥°å’Œæ“ä½œ

C++11 å°†å¼‚å¸¸çš„å£°æ˜ç®€åŒ–ä¸ºä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š

1. å‡½æ•°å¯èƒ½æŠ›å‡ºä»»ä½•å¼‚å¸¸
2. å‡½æ•°ä¸èƒ½æŠ›å‡ºä»»ä½•å¼‚å¸¸

å¹¶ä½¿ç”¨ `noexcept` å¯¹è¿™ä¸¤ç§è¡Œä¸ºè¿›è¡Œé™åˆ¶ï¼Œä¾‹å¦‚ï¼š

```C++
void may_throw();           // å¯èƒ½æŠ›å‡ºå¼‚å¸¸
void no_throw() noexcept;   // ä¸å¯èƒ½æŠ›å‡ºå¼‚å¸¸
```

ä½¿ç”¨ `noexcept` ä¿®é¥°è¿‡çš„å‡½æ•°å¦‚æœæŠ›å‡ºå¼‚å¸¸ï¼Œç¼–è¯‘å™¨ä¼šä½¿ç”¨ `std::terminate()` æ¥ç«‹å³ç»ˆæ­¢ç¨‹åºè¿è¡Œã€‚

`noexcept` è¿˜èƒ½ç”¨ä½œæ“ä½œç¬¦ï¼Œç”¨äºæ“ä½œä¸€ä¸ªè¡¨è¾¾å¼ï¼Œå½“è¡¨è¾¾å¼æ— å¼‚å¸¸æ—¶ï¼Œè¿”å› `true`ï¼Œå¦åˆ™è¿”å› `false`ã€‚

```C++
#include <iostream>

void may_throw() {
    throw true;
}
auto non_block_throw = []{
    may_throw();
};
void no_throw() noexcept {
    return;
}

auto block_throw = []() noexcept {
    no_throw();
};

int main()
{
    std::cout << std::boolalpha
    << "may_throw() noexcept? " << noexcept(may_throw()) << std::endl
    << "no_throw() noexcept? " << noexcept(no_throw()) << std::endl
    << "lmay_throw() noexcept? " << noexcept(non_block_throw()) << std::endl
    << "lno_throw() noexcept? " << noexcept(block_throw()) << std::endl;

    return 0;
}
```

`noexcept` ä¿®é¥°å®Œä¸€ä¸ªå‡½æ•°ä¹‹åèƒ½å¤Ÿèµ·åˆ°å°é”å¼‚å¸¸æ‰©æ•£çš„åŠŸæ•ˆï¼Œå¦‚æœå†…éƒ¨äº§ç”Ÿå¼‚å¸¸ï¼Œå¤–éƒ¨ä¹Ÿä¸ä¼šè§¦å‘ã€‚ä¾‹å¦‚ï¼š

```C++
try {
    may_throw();
} catch (...) {
    std::cout << "æ•è·å¼‚å¸¸, æ¥è‡ª my_throw()" << std::endl;
}

try {
    non_block_throw();
} catch (...) {
    std::cout << "æ•è·å¼‚å¸¸, æ¥è‡ª non_block_throw()" << std::endl;
}

try {
    block_throw();
} catch (...) {
    std::cout << "æ•è·å¼‚å¸¸, æ¥è‡ª block_throw()" << std::endl;
}
```

æœ€ç»ˆè¾“å‡ºä¸ºï¼š

```
æ•è·å¼‚å¸¸, æ¥è‡ª my_throw()
æ•è·å¼‚å¸¸, æ¥è‡ª non_block_throw()
```

# å­—é¢é‡

## åŸå§‹å­—ç¬¦ä¸²å­—é¢é‡

ä¼ ç»Ÿ C++ é‡Œé¢è¦ç¼–å†™ä¸€ä¸ªå……æ»¡ç‰¹æ®Šå­—ç¬¦çš„å­—ç¬¦ä¸²å…¶å®æ˜¯éå¸¸ç—›è‹¦çš„ä¸€ä»¶äº‹æƒ…ï¼Œæ¯”å¦‚ä¸€ä¸ªåŒ…å« HTML æœ¬ä½“çš„å­—ç¬¦ä¸²éœ€è¦æ·»åŠ å¤§é‡çš„è½¬ä¹‰ç¬¦ï¼Œä¾‹å¦‚ä¸€ä¸ªWindows ä¸Šçš„æ–‡ä»¶è·¯å¾„ç»å¸¸ä¼šï¼š`C:\\What\\The\\Fxxk`ã€‚

C++11 æä¾›äº†åŸå§‹å­—ç¬¦ä¸²å­—é¢é‡çš„å†™æ³•ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªå­—ç¬¦ä¸²å‰æ–¹ä½¿ç”¨ `R` æ¥ä¿®é¥°è¿™ä¸ªå­—ç¬¦ä¸²ï¼ŒåŒæ—¶ï¼Œå°†åŸå§‹å­—ç¬¦ä¸²ä½¿ç”¨æ‹¬å·åŒ…è£¹ï¼Œä¾‹å¦‚ï¼š

```C++
#include <iostream>
#include <string>

int main() {
    std::string str = R"(C:\\What\\The\\Fxxk)";
    std::cout << str << std::endl;
    return 0;
}
```

#### è‡ªå®šä¹‰å­—é¢é‡

C++11 å¼•è¿›äº†è‡ªå®šä¹‰å­—é¢é‡çš„èƒ½åŠ›ï¼Œé€šè¿‡é‡è½½åŒå¼•å·åç¼€è¿ç®—ç¬¦å®ç°ï¼š

```C++
// å­—ç¬¦ä¸²å­—é¢é‡è‡ªå®šä¹‰å¿…é¡»è®¾ç½®å¦‚ä¸‹çš„å‚æ•°åˆ—è¡¨
std::string operator"" _wow1(const char *wow1, size_t len) {
    return std::string(wow1)+"woooooooooow, amazing";
}

std::string operator"" _wow2 (unsigned long long i) {
    return std::to_string(i)+"woooooooooow, amazing";
}

int main() {
    auto str = "abc"_wow1;
    auto num = 1_wow2;
    std::cout << str << std::endl;
    std::cout << num << std::endl;
    return 0;
}
```

è‡ªå®šä¹‰å­—é¢é‡æ”¯æŒå››ç§å­—é¢é‡ï¼š

1. æ•´å‹å­—é¢é‡ï¼šé‡è½½æ—¶å¿…é¡»ä½¿ç”¨ `unsigned long long`ã€`const char *`ã€æ¨¡æ¿å­—é¢é‡ç®—ç¬¦å‚æ•°ï¼Œåœ¨ä¸Šé¢çš„ä»£ç ä¸­ä½¿ç”¨çš„æ˜¯å‰è€…ï¼›
2. æµ®ç‚¹å‹å­—é¢é‡ï¼šé‡è½½æ—¶å¿…é¡»ä½¿ç”¨ `long double`ã€`const char *`ã€æ¨¡æ¿å­—é¢é‡ç®—ç¬¦ï¼›
3. å­—ç¬¦ä¸²å­—é¢é‡ï¼šå¿…é¡»ä½¿ç”¨ `(const char *, size_t)` å½¢å¼çš„å‚æ•°è¡¨ï¼›
4. å­—ç¬¦å­—é¢é‡ï¼šå‚æ•°åªèƒ½æ˜¯ `char`, `wchar_t`, `char16_t`, `char32_t` è¿™å‡ ç§ç±»å‹ã€‚